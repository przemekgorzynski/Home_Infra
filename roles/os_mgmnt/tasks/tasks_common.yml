---
- name: Update system
  ansible.builtin.apt:
    name: "*"
    state: latest
    update_cache: true
    autoremove: true

- name: Install standard packages
  ansible.builtin.apt:
    name: "{{ standard_packages }}"
    state: present

- name: Ensure Python Kubernetes client is installed on K3s host
  ansible.builtin.pip:
    name: "{{ python_packages }}"
    state: present
    extra_args: "--break-system-packages"

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"

- name: Set timezone to Europe/Warsaw
  community.general.timezone:
    name: "{{ timezone }}"

- name: SSH configure
  tags:
    - ssh
  block:
    - name: Set ssh banner
      ansible.builtin.copy:
        src: files/ssh-banner.net
        dest: /etc/issue.net
        owner: root
        group: root
        mode: '0644'
    - name: Set SSH config files
      ansible.posix.synchronize:
        src: files/sshd_config/
        dest: /etc/ssh/sshd_config.d/
        private_key: "{{ lookup('file', admin_user[0].public_key_path) }}"
        delete: true
        owner: false
        group: false

- name: Configure 2nd ethernet port
  tags:
    - eth
  when:  configure_second_eth
  block:
    - name: Ensure netplan directory exists
      file:
        path: /etc/netplan
        state: directory
        mode: '0755'
    - name: Configure enp3s0 for DHCP
      copy:
        dest: /etc/netplan/01-enp3s0-dhcp.yaml
        content: |
          network:
            version: 2
            ethernets:
              enp3s0:
                dhcp4: yes
        owner: root
        group: root
        mode: '0644'
    - name: Apply netplan configuration
      shell: netplan apply
